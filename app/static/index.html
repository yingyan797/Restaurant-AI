<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Booking System</title>
    <link rel="icon" type="image/png" href="static/icon.png"/>
    <style>
        table {width:100%; border-collapse: collapse; margin-top: 10px}
        thead {background-color: lightcyan;}
        tbody {background-color:#f2f2f2}
        th, td {text-align: left; border: 1px solid #ddd; font-size: small;}
        h3 {background-color: skyblue; padding: 3px; border-radius: 2px; border: skyblue solid;}
        h3:hover {border: dashed; cursor: pointer; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; height: 100vh; }
        .container { display: flex; height: 100vh; }
        .chat-panel { width: 50%; padding: 20px; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .booking-panel { width: 50%; padding: 20px; overflow-y: auto; }
        .chat-messages { flex: 1; border: 1px solid #ddd; border-radius: 5px; padding: 10px; overflow-y: auto; margin-bottom: 10px; background: #f9f9f9; }
        .chat-input { display: flex; gap: 10px; align-items: flex-end; }
        .chat-input textarea { width: 85%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: none; height: 50px; font-family: Arial, sans-serif; }
        .chat-input button { width: 80px; height: 50px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .chat-input button:hover { background: 007bff; }
        .message { padding: 8px; border-radius: 5px; margin-bottom: 5px;}
        .user-message { background: green; color: white; text-align: right; max-width: 85%; margin-right: 2px; margin-left: auto;}
        .bot-message { background: #e9ecef; color: #333; max-width: 85%; margin-left: 2px; margin-right: auto;}
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; background-color: lightcyan;}
        input, select, textarea, button { margin: 5px 0; padding: 8px; box-sizing: border-box; }
        button { background: #333; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .cancelled { background-color: lightgoldenrodyellow; }
        .email-gate { position: absolute; top: 0; left: 0; width: 50%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .email-form { background: white; padding: 30px; border-radius: 10px; text-align: center; max-width: 400px; }
        .email-form input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .email-form button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .email-form button:hover { background: #0056b3; }
        .email-display {font-size: small; color: green; margin-left: 10px;}
        .email-display:hover {cursor: pointer; border-bottom: solid;}
        .hidden { display: none; }
        .optional-section { background: #f0f8ff; border: 1px dashed #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .toggle-btn { background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; }
        .toggle-btn:hover { background: #555; }
        .field-group { margin: 10px 0; }
        .field-label { font-weight: bold; margin-right: 10px; }
        .inline-fields { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .inline-fields input, .inline-fields select { flex: 1; min-width: 120px; }
    </style>
</head>
<body>
    <div id="emailGate" class="email-gate">
        <div class="email-form">
            <h2>Welcome to Restaurant Booking</h2>
            <p>Please provide a valid email address to begin using the chatbot:</p>
            <input type="email" id="userEmail" value=yingyan797@restaurantai.com required>
            <button onclick="validateEmail()">Continue</button>
            <div id="emailError" style="color: red; margin-top: 10px; display: none;"></div>
        </div>
    </div>
    <div class="container" id="mainContainer">
        <div class="chat-panel">
            <h2>Restaurant AI 
                <span id="login" class="email-display" title="Click to change" onclick="changeEmail()"></span>
            </h2>
            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">Hello! I'm your restaurant booking assistant. I can help you check availability, make bookings, or manage existing reservations. What would you like to do?</div>
            </div>
            <div class="chat-input">
                <textarea class="message" id="chatInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)"></textarea>
                <button onclick="sendMessage()">Send</button>
            </div>
            <div style="background-color: azure;">
                <button onclick="writeMessage('Yes')">Yes</button>
                <button onclick="writeMessage('No')">No</button>
                <button onclick="writeMessage('0')" style="height: 30px;">0</button>
                <button onclick="writeMessage('1')" style="height: 30px;">1</button>
                <button onclick="writeMessage('2')" style="height: 30px;">2</button>
                <button onclick="writeMessage('3')" style="height: 30px;">3</button>
                <button onclick="writeMessage('4')" style="height: 30px;">4</button>
                <button onclick="writeMessage('5')" style="height: 30px;">5</button>  
                <button onclick="writeMessage('6')" style="height: 30px;">6</button>  
                <button onclick="writeMessage('7')" style="height: 30px;">7</button>  
                <button onclick="writeMessage('8')" style="height: 30px;">8</button>  
                <button onclick="writeMessage('9')" style="height: 30px;">9</button> | 
                <button onclick="resetChat()" style="color: salmon;">Reset chat</button>
            </div>
        </div>
        
        <div class="booking-panel" style="background-image: url('static/archer3.jpg');">            
            <h3 onclick="showSection('avail')">Check Availability</h3>
            <div class="section" id="avail">
                <div class="field-group">
                    <span class="field-label">Restaurant name:</span>
                    <input type="text" id="availName" value="TheHungryUnicorn" required>
                </div>
                <div class="field-group">
                    <div class="inline-fields">
                        <span class="field-label">Visit date:</span>
                        <input type="date" id="visitDate" required>
                        <span class="field-label">Party size:</span>
                        <input type="number" id="partySize" placeholder="1-20" min="1" max="20" required>
                    </div>
                </div>
                <div class="field-group">
                    <span class="field-label">Channel code:</span>
                    <select id="availChannelCode">
                        <option value="ONLINE">ONLINE</option>
                        <option value="PHONE">PHONE</option>
                        <option value="WALK_IN">WALK_IN</option>
                    </select>
                </div>
                <button onclick="checkAvailability()">Check Availability</button>
                <div id="availabilityResult" class="result" style="display:none;"></div>
            </div>

            <h3 onclick="showSection('book')">Make Booking</h3>
            <div class="section" id="book">
                <div class="field-group">
                    <span class="field-label">Restaurant name:</span>
                    <input type="text" id="bookingName" value="TheHungryUnicorn" required>
                </div>
                <div class="field-group">
                    <div class="inline-fields">
                        <span class="field-label">Date:</span>
                        <input type="date" id="bookingDate" required>
                        <span class="field-label">Time:</span>
                        <input type="time" id="bookingTime" required>
                        <span class="field-label">Party size:</span>
                        <input type="number" id="bookingPartySize" placeholder="1-20" min="1" max="20" required>
                    </div>
                </div>
                <div class="field-group">
                    <span class="field-label">Channel code:</span>
                    <select id="bookingChannelCode">
                        <option value="ONLINE">ONLINE</option>
                        <option value="PHONE">PHONE</option>
                        <option value="WALK_IN">WALK_IN</option>
                    </select>; 
                <button class="toggle-btn" onclick="toggleOptional('bookingOptional')">Show Optional Fields ... </button>

                </div>
                
                <div id="bookingOptional" class="optional-section" style="display:none;">
                    <div class="field-group">
                        <span class="field-label">Special requests:</span>
                        <textarea id="specialRequests" placeholder="Special Requests" rows="2" style="width: 95%;"></textarea>
                    </div>
                    <div class="field-group">
                        <div class="inline-fields">
                            <span class="field-label">Room number:</span>
                            <input type="text" id="roomNumber" placeholder="Room/Table Number">
                            <label><input type="checkbox" id="isLeaveTimeConfirmed"> Leave time confirmed</label>
                        </div>
                    </div>
                    
                    <h4>Customer Information (Optional)</h4>
                    <div class="field-group">
                        <div class="inline-fields">
                            <select id="customerTitle">
                                <option value="">Title</option>
                                <option value="Mr">Mr</option>
                                <option value="Mrs">Mrs</option>
                                <option value="Ms">Ms</option>
                                <option value="Dr">Dr</option>
                            </select>
                            <input type="text" id="firstName" placeholder="First Name">
                            <input type="text" id="surname" placeholder="Surname">
                        </div>
                    </div>
                    <div class="field-group">
                        <div class="inline-fields">
                            <input type="email" id="email" placeholder="Email">
                            <input type="tel" id="mobile" placeholder="Mobile">
                            <input type="tel" id="phone" placeholder="Landline">
                        </div>
                    </div>
                    <div class="field-group">
                        <div class="inline-fields">
                            <input type="text" id="mobileCountryCode" placeholder="Mobile Country Code" style="width: 80px;">
                            <input type="text" id="phoneCountryCode" placeholder="Phone Country Code" style="width: 80px;">
                        </div>
                    </div>
                    <div class="field-group">
                        <label><input type="checkbox" id="receiveEmailMarketing"> Receive email marketing</label>
                        <label><input type="checkbox" id="receiveSmsMarketing"> Receive SMS marketing</label>
                    </div>
                </div>
                
                <button onclick="makeBooking()">Make Booking</button>
                <div id="bookingResult" class="result" style="display:none;"></div>
            </div>

            <h3 onclick="showSection('manage')">Manage Booking</h3>
            <div class="section" id="manage">
                <div class="field-group">
                    <span class="field-label">Restaurant name:</span>
                    <input type="text" id="manageName" value="TheHungryUnicorn">
                </div>
                <div class="field-group">
                    <span class="field-label">Booking reference:</span>
                    <input type="text" id="bookingRef" placeholder="Booking Reference" style="width: 95%;">
                </div>
                <button onclick="getBooking()">Get Booking Details</button>
                <div id="manageResult" class="result" style="display:none;"></div>
                
                <div id="updateFields" style="display:none; margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background-color: white;">
                    <h4>Update Booking (Optional Fields)</h4>
                    <div class="field-group">
                        <div class="inline-fields">
                            <span class="field-label">New date:</span>
                            <input type="date" id="updateDate">
                            <span class="field-label">New time:</span>
                            <input type="time" id="updateTime">
                            <span class="field-label">Party size:</span>
                            <input type="number" id="updatePartySize" min="1" max="20">
                        </div>
                    </div>
                    <div class="field-group">
                        <span class="field-label">Special requests:</span>
                        <textarea id="updateSpecialRequests" placeholder="Updated Special Requests" style="width: 95%;"></textarea>
                    </div>
                    <div class="field-group">
                        <label><input type="checkbox" id="updateIsLeaveTimeConfirmed"> Leave time confirmed</label>
                    </div>
                    <button onclick="updateBooking()">Update Booking</button>
                </div>
                
                <div id="cancelSection" style="display:none; margin: 10px 0; padding: 10px; border: 1px solid #f8d7da; border-radius: 5px; background-color: #f8d7da;">
                    <h4>Cancel Booking</h4>
                    <div class="field-group">
                        <span class="field-label">Microsite name:</span>
                        <input type="text" id="cancelMicrositeName" value="TheHungryUnicorn">
                    </div>
                    <div class="field-group">
                        <span class="field-label">Cancellation reason:</span>
                        <select id="cancellationReasonId">
                            <option value="1">Customer Request</option>
                            <option value="2">Restaurant Closure</option>
                            <option value="3">Weather</option>
                            <option value="4">Emergency</option>
                            <option value="5">No Show</option>
                        </select>
                    </div>
                    <button onclick="cancelBooking()" style="background: #dc3545;">Cancel Booking</button>
                </div>
                
                <button onclick="showCancelSection()" class="toggle-btn" id="cancelOptionBtn">Show Cancel Options ... </button>
            </div>
        </div>
    </div>

    <script>
        function showSection(secId) {
            const section = document.getElementById(secId);
            if (section.style.display == "none") {
                section.style.display = "block";
            } else {
                section.style.display = "none";
            }
        }

        const API_BASE = '/api/ConsumerApi/v1/Restaurant';
        const AUTH_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1bmlxdWVfbmFtZSI6ImFwcGVsbGErYXBpQHJlc2RpYXJ5LmNvbSIsIm5iZiI6MTc1NDQzMDgwNSwiZXhwIjoxNzU0NTE3MjA1LCJpYXQiOjE3NTQ0MzA4MDUsImlzcyI6IlNlbGYiLCJhdWQiOiJodHRwczovL2FwaS5yZXNkaWFyeS5jb20ifQ.g3yLsufdk8Fn2094SB3J3XW-KdBc0DY9a2Jiu_56ud8';
        let userSessionEmail = "";

        function toggleOptional(sectionId) {
            const section = document.getElementById(sectionId);
            const button = event.target;
            if (section.style.display === 'none') {
                section.style.display = 'block';
                button.textContent = 'Hide Optional Fields';
            } else {
                section.style.display = 'none';
                button.textContent = 'Show Optional Fields';
            }
        }

        function showCancelSection() {
            const section = document.getElementById('cancelSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
            const button = document.getElementById("cancelOptionBtn");
            button.textContent = section.style.display === 'none' ? 'Show Cancel Options ... ' : 'Hide Cancel Options ... ';
        }

        async function checkAvailability() {
            const name = document.getElementById('availName').value;
            const date = document.getElementById('visitDate').value;
            const partySize = document.getElementById('partySize').value;
            const channelCode = document.getElementById('availChannelCode').value;
            
            if (!date || !partySize) {
                showResult('availabilityResult', 'Please fill in all fields', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('VisitDate', date);
            formData.append('PartySize', partySize);
            formData.append('ChannelCode', channelCode);

            try {
                const response = await fetch(`${API_BASE}/${name}/AvailabilitySearch`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` },
                    body: formData
                });
                
                const data = await response.json();
                if (response.ok) {
                    const slots = data.available_slots.filter(slot => slot.available);
                    const html = slots.length ? 
                        `Available times: ${slots.map(s => s.time).join(', ')}` :
                        'No availability for this date';
                    showResult('availabilityResult', html, 'success');
                } else {
                    showResult('availabilityResult', data.detail, 'error');
                }
            } catch (error) {
                showResult('availabilityResult', 'Error checking availability', 'error');
            }
        }

        async function makeBooking() {
            const name = document.getElementById('bookingName').value;
            const formData = new FormData();
            
            // Required fields
            formData.append('VisitDate', document.getElementById('bookingDate').value);
            formData.append('VisitTime', document.getElementById('bookingTime').value);
            formData.append('PartySize', document.getElementById('bookingPartySize').value);
            formData.append('ChannelCode', document.getElementById('bookingChannelCode').value);
            
            // Optional fields
            const specialRequests = document.getElementById('specialRequests').value;
            const roomNumber = document.getElementById('roomNumber').value;
            const isLeaveTimeConfirmed = document.getElementById('isLeaveTimeConfirmed').checked;
            
            if (specialRequests) formData.append('SpecialRequests', specialRequests);
            if (roomNumber) formData.append('RoomNumber', roomNumber);
            if (isLeaveTimeConfirmed) formData.append('IsLeaveTimeConfirmed', 'true');
            
            // Customer information (all optional)
            const title = document.getElementById('customerTitle').value;
            const firstName = document.getElementById('firstName').value;
            const surname = document.getElementById('surname').value;
            const email = document.getElementById('email').value;
            const mobile = document.getElementById('mobile').value;
            const phone = document.getElementById('phone').value;
            const mobileCountryCode = document.getElementById('mobileCountryCode').value;
            const phoneCountryCode = document.getElementById('phoneCountryCode').value;
            const receiveEmailMarketing = document.getElementById('receiveEmailMarketing').checked;
            const receiveSmsMarketing = document.getElementById('receiveSmsMarketing').checked;
            
            if (title) formData.append('Customer[Title]', title);
            if (firstName) formData.append('Customer[FirstName]', firstName);
            if (surname) formData.append('Customer[Surname]', surname);
            if (email) formData.append('Customer[Email]', email);
            if (mobile) formData.append('Customer[Mobile]', mobile);
            if (phone) formData.append('Customer[Phone]', phone);
            if (mobileCountryCode) formData.append('Customer[MobileCountryCode]', mobileCountryCode);
            if (phoneCountryCode) formData.append('Customer[PhoneCountryCode]', phoneCountryCode);
            if (receiveEmailMarketing) formData.append('Customer[ReceiveEmailMarketing]', 'true');
            if (receiveSmsMarketing) formData.append('Customer[ReceiveSmsMarketing]', 'true');

            try {
                const response = await fetch(`${API_BASE}/${name}/BookingWithStripeToken`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` },
                    body: formData
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('bookingResult', `Booking confirmed! Reference: ${data.booking_reference}`, 'success');
                } else {
                    showResult('bookingResult', data.detail, 'error');
                }
            } catch (error) {
                showResult('bookingResult', 'Error making booking', 'error');
            }
        }

        async function getBooking() {
            const name = document.getElementById('manageName').value;
            const ref = document.getElementById('bookingRef').value;
            if (!ref) {
                showResult('manageResult', 'Please enter booking reference', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/${name}/Booking/${ref}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                const data = await response.json();
                if (response.ok) {
                    const html = `
                        <strong>Booking ${data.booking_reference}</strong><br>
                        Date: ${data.visit_date} at ${data.visit_time}<br>
                        Party Size: ${data.party_size}<br>
                        Status: ${data.status}<br>
                        Customer: ${data.customer.first_name} ${data.customer.surname}
                    `;
                    showResult('manageResult', html, data.status == "confirmed" ? 'success': 'cancelled');
                    
                    // Show update fields and populate with current values
                    document.getElementById('updateFields').style.display = 'block';
                    document.getElementById('updateDate').value = data.visit_date;
                    document.getElementById('updateTime').value = data.visit_time;
                    document.getElementById('updatePartySize').value = data.party_size;
                    document.getElementById('updateSpecialRequests').value = data.special_requests || '';
                } else {
                    showResult('manageResult', data.detail, 'error');
                }
            } catch (error) {
                showResult('manageResult', 'Error retrieving booking', 'error');
            }
        }

        async function updateBooking() {
            const name = document.getElementById('manageName').value;
            const ref = document.getElementById('bookingRef').value;
            if (!ref) {
                showResult('manageResult', 'Please get booking first', 'error');
                return;
            }

            const formData = new FormData();
            const newDate = document.getElementById('updateDate').value;
            const newTime = document.getElementById('updateTime').value;
            const newPartySize = document.getElementById('updatePartySize').value;
            const newSpecialRequests = document.getElementById('updateSpecialRequests').value;
            const isLeaveTimeConfirmed = document.getElementById('updateIsLeaveTimeConfirmed').checked;

            if (newDate) formData.append('VisitDate', newDate);
            if (newTime) formData.append('VisitTime', newTime);
            if (newPartySize) formData.append('PartySize', newPartySize);
            if (newSpecialRequests) formData.append('SpecialRequests', newSpecialRequests);
            if (isLeaveTimeConfirmed) formData.append('IsLeaveTimeConfirmed', 'true');

            try {
                const response = await fetch(`${API_BASE}/${name}/Booking/${ref}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` },
                    body: formData
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('manageResult', `Booking ${ref} updated successfully`, 'success');
                    document.getElementById('updateFields').style.display = 'none';
                } else {
                    showResult('manageResult', data.detail, 'error');
                }
            } catch (error) {
                showResult('manageResult', 'Error updating booking', 'error');
            }
        }

        async function cancelBooking() {
            const name = document.getElementById('manageName').value;
            const ref = document.getElementById('bookingRef').value;
            const micrositeName = document.getElementById('cancelMicrositeName').value;
            const cancellationReasonId = document.getElementById('cancellationReasonId').value;
            
            if (!ref) {
                showResult('manageResult', 'Please enter booking reference', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('micrositeName', micrositeName);
            formData.append('bookingReference', ref);
            formData.append('cancellationReasonId', cancellationReasonId);

            try {
                const response = await fetch(`${API_BASE}/${name}/Booking/${ref}/Cancel`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` },
                    body: formData
                });
                
                const data = await response.json();
                if (response.ok) {
                    showResult('manageResult', `Booking ${ref} cancelled successfully`, 'cancelled');
                } else {
                    showResult('manageResult', data.detail, 'error');
                }
            } catch (error) {
                showResult('manageResult', 'Error cancelling booking', 'error');
            }
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // Email validation
        function validateEmail() {
            const email = document.getElementById('userEmail').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!email) {
                showEmailError('Please enter an email address');
                return;
            }
            
            if (!emailRegex.test(email)) {
                showEmailError('Please enter a valid email address');
                return;
            }
            if (userSessionEmail != "" && userSessionEmail != email) {
                resetChat();
            }
            userSessionEmail = email;
            sessionStorage.setItem('userEmail', email);
            document.getElementById('login').innerText = "Login as: "+ email;
            document.getElementById('emailGate').style.display = 'none';
        }

        function changeEmail() {
            document.getElementById('userEmail').value = userSessionEmail;
            document.getElementById('login').innerText = "";
            document.getElementById('emailGate').style.display = 'flex';
        }
        
        function showEmailError(message) {
            const errorDiv = document.getElementById('emailError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function writeMessage(message) {
            document.getElementById("chatInput").value = message;
            sendMessage();
        }

        function addMessage(message, isUser = false) {
            const chatInput = document.getElementById("chatInput");
            chatInput.style.backgroundColor = "white";
            chatInput.style.color = "black";
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.innerHTML = message;

            const writeback = document.createElement("b");
            writeback.style.marginLeft = "25px";
            writeback.style.cursor = "pointer";
            writeback.style.color = "skyblue";
            writeback.style.fontSize = "small";
            writeback.style.borderBottom = "dashed";
            writeback.textContent = "Copy";
            writeback.onclick = () => {
                chatInput.value = message;
                chatInput.style.backgroundColor = "green";
                chatInput.style.color = "white";
            };

            messageDiv.appendChild(writeback); // actually add the button to the div

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }


        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addMessage(message, true);
            input.value = '';

            // Simple chatbot logic
            const response = await processMessage(message);
            addMessage(response);
        }

        async function processMessage(message) {
            try {
                const response = await fetch('/api/ai/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message, email: userSessionEmail })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.response;
                } else {
                    const errorData = await response.json();
                    return `Sorry, I'm having trouble processing your request: ${errorData.detail || 'Please try again.'}`;
                }
            } catch (error) {
                console.error('Chat error:', error);
                return 'Sorry, I\'m currently unavailable. Please try again later.';
            }
        }

        async function resetChat() {
            try {
                await fetch('/api/ai/reset', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userSessionEmail })
                });
                document.getElementById('chatMessages').innerHTML = '<div class="message bot-message">Hello! I\'m your restaurant booking assistant. I can help you check availability, make bookings, or manage existing reservations. What would you like to do?</div>';
            } catch (error) {
                console.error('Reset error:', error);
            }
        }
    </script>
</body>
</html>